name: Daily Portfolio Fetch

on:
  schedule:
    - cron: '0 10 * * 1-5'  # 10:00 UTC Monâ€“Fri (~15:30 IST)
  workflow_dispatch:

jobs:
  fetch-and-commit:
    # ðŸ›‘ Prevent self-triggered runs caused by bot commits
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    # ðŸš¦ Prevent overlapping runs (cron + manual)
    concurrency:
      group: portfolio-fetch
      cancel-in-progress: true

    permissions:
      contents: write   # âœ… allows git push using GITHUB_TOKEN

    steps:
      - name: Checkout repo (with write)
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run daily fetch
        env:
          PORTFOLIO_DB: ./portfolio.db
        run: |
          python daily_fetch.py

      - name: Commit updated DB (if changed)
        shell: bash
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
          git add portfolio.db || true

          if ! git diff --cached --quiet; then
            COMMIT_MSG="chore: daily snapshot update ($(date -u))"
            git commit -m "$COMMIT_MSG" || echo "commit failed"
            
            # âœ… Ensure we have latest branch before pushing
            git fetch origin main
            git merge origin/main --no-edit || true

            # âœ… Try normal push, fallback to force if needed
            git push || git push --force
          else
            echo "No changes to commit"
          fi
